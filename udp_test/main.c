#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>


// Testcases

// 1. 16 len. correct 
unsigned char dgramm1[] = 
    {0xbe, 0xef, 0x10, 0xde, 0xaf, 0xde, 0xad, 0xde, 
     0xaf,0xde, 0xad,0xde, 0xaf, 0xaf,0xcf,0x77};
// 2. 16 len. crc wrong
unsigned char dgramm2[] = {0xbe, 0xef, 0x10, 0xde,0xaf,0xde, 0xad, 0xde, 0xaf,0xde, 0xad,0xde, 0xaf, 0xaf,0xcf,0x78};
// 3. 32 len. correct 
unsigned char dgramm3[] = {
    0xbe, 0xef, 0x20, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xaf, 0xef, 0x66};
// 4. 14 len. wrong len
unsigned char dgramm4[] = {0xbe, 0xef, 0x10, 0xde,0xaf,0xde, 0xad, 0xde, 0xaf,0xde, 0xad,0xde, 0xaf, 0xaf};
// 5. 0 len. wrong len
unsigned char dgramm5[] = {};
// 6. 128 len. correct 
unsigned char dgramm6[] = {
    0xbe, 0xef, 0x80, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xaf, 0x8f, 0x63};
// 7. 130 len. len wrong 
unsigned char dgramm7[] = {
    0xbe, 0xef, 0x82, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe, 0xed, 0xfe,
    0xed, 0xfe, 0xed, 0xfe, 0xed, 0xaf, 0xde, 0xad,
    0x05, 0x0c};

void send_udp(const unsigned char *data, size_t size, const char *ip, int port, int source_port) {
    int sockfd;
    int sent_size;
    struct sockaddr_in dest_addr, src_addr;

    // Create a socket
    if ((sockfd = socket(AF_INET, SOCK_DGRAM, 0)) < 0) {
        perror("socket creation failed");
        exit(EXIT_FAILURE);
    }

    // Bind to the specific source port if provided
    if (source_port > 0) {
        memset(&src_addr, 0, sizeof(src_addr));
        src_addr.sin_family = AF_INET;
        src_addr.sin_port = htons(source_port);
        src_addr.sin_addr.s_addr = INADDR_ANY;

        if (bind(sockfd, (const struct sockaddr *)&src_addr, sizeof(src_addr)) < 0) {
            perror("bind failed");
            close(sockfd);
            exit(EXIT_FAILURE);
        }
    }

    // Set up destination address
    memset(&dest_addr, 0, sizeof(dest_addr));
    dest_addr.sin_family = AF_INET;
    dest_addr.sin_port = htons(port);
    if (inet_pton(AF_INET, ip, &dest_addr.sin_addr) <= 0) {
        perror("inet_pton failed");
        close(sockfd);
        exit(EXIT_FAILURE);
    }

    // Send the data
     sent_size = sendto(sockfd, data, size, 0, (const struct sockaddr *)&dest_addr, sizeof(dest_addr));
     if(sent_size<0){ 
        perror("sendto failed");
        close(sockfd);
        exit(EXIT_FAILURE);
    }

    printf("Data sent size %d successfully from port %d\n", sent_size, source_port);

    // Close the socket
    close(sockfd);
}


int main(int argc, char *argv[]) {
    if (argc != 5) {
        fprintf(stderr, "Usage: %s <data_choice> <dest_ip> <dest_port> <source_port>\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    int choice = atoi(argv[1]);
    const char *dest_ip = argv[2];
    int dest_port = atoi(argv[3]);
    int source_port = atoi(argv[4]);

    switch (choice) {
        case 1:
            send_udp(dgramm1, sizeof(dgramm1), dest_ip, dest_port, source_port);
            break;
        case 2:
            send_udp(dgramm2, sizeof(dgramm2), dest_ip, dest_port, source_port);
            break;
        case 3:
            send_udp(dgramm3, sizeof(dgramm3), dest_ip, dest_port, source_port);
            break;
        case 4:
            send_udp(dgramm4, sizeof(dgramm4), dest_ip, dest_port, source_port);
            break;
        case 5:
            send_udp(dgramm5, sizeof(dgramm5), dest_ip, dest_port, source_port);
            break;
        case 6:
            send_udp(dgramm6, sizeof(dgramm6), dest_ip, dest_port, source_port);
            break;
        case 7:
            send_udp(dgramm7, sizeof(dgramm7), dest_ip, dest_port, source_port);
            break;
        default:
            fprintf(stderr, "Invalid data choice: %d\n", choice);
            exit(EXIT_FAILURE);
    }

    return 0;
}


